<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Waterdrop Survivor - Dopamin Max</title>

<style>
html, body { margin:0; padding:0; overflow:hidden; background:#111; }
canvas { display:block; }
#hud { position:absolute; top:10px; left:10px; color:#fff; font-family:sans-serif; z-index:10; }
#lvlup { position:absolute; top:50%; left:50%; transform:translate(-50%, -50%) scale(0); font-size:48px; color:#ff0; text-shadow:0 0 10px #fff; z-index:20; pointer-events:none; }
</style>

<!-- Three.js CDN (rÃ¤tt version, funkar pÃ¥ Pages) -->
<script src="https://cdn.jsdelivr.net/npm/three@0.176.0/build/three.min.js"></script>

</head>
<body>
<div id="hud">
HP: <span id="hp">100</span> |
LVL: <span id="lvl">1</span> |
KILLS: <span id="kills">0</span>
</div>
<div id="lvlup">â—ï¸ğŸ’¥ LEVEL UP â—ï¸ğŸ’¥</div>

<script>
/* ---------- GAME VARIABLES ---------- */
let scene, camera, renderer;
let player, enemies = [], meteors = [], expGems = [], particles = [];
let lvl = 1, kills = 0, hp = 100, exp = 0;
let swipeStart = null;

/* ---------- INIT SCENE ---------- */
function init() {
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
  camera.position.set(0,30,30);
  camera.lookAt(0,0,0);
  renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  // Player
  const geo = new THREE.SphereGeometry(1,16,16);
  const mat = new THREE.MeshStandardMaterial({color:0x00f, roughness:0.5});
  player = new THREE.Mesh(geo, mat);
  scene.add(player);
  player.position.set(0,1,0);
  player.speed = 0.5;
  player.dashCooldown = 0;

  // Lights
  const light = new THREE.DirectionalLight(0xffffff,1);
  light.position.set(10,20,10);
  scene.add(light);
  scene.add(new THREE.AmbientLight(0x404040));

  // Ground
  const ground = new THREE.Mesh(new THREE.PlaneGeometry(100,100,10,10), new THREE.MeshStandardMaterial({color:0x222}));
  ground.rotation.x = -Math.PI/2;
  scene.add(ground);

  /* ---------- TOUCH SWIPE DASH ---------- */
  window.addEventListener('touchstart', e => { swipeStart = e.touches[0]; });
  window.addEventListener('touchend', e => {
    if(!swipeStart) return;
    const swipeEnd = e.changedTouches[0];
    const dx = swipeEnd.clientX - swipeStart.clientX;
    const dy = swipeEnd.clientY - swipeStart.clientY;
    dash(dx, dy);
    swipeStart = null;
  });

  animate();
}

/* ---------- DASH ---------- */
function dash(dx, dy) {
  if(player.dashCooldown>0) return;
  const length = Math.sqrt(dx*dx + dy*dy);
  if(length<5) return;
  const dirX = dx/length;
  const dirZ = -dy/length;
  player.position.x += dirX*5;
  player.position.z += dirZ*5;
  player.dashCooldown = 60;
}

/* ---------- LEVEL UP ---------- */
function lvlUp() {
  lvl++;
  document.getElementById('lvl').innerText = lvl;

  // Random small variation in HP and EXP
  hp += 5 + Math.floor(Math.random()*3);
  exp = 0;
  document.getElementById('hp').innerText = hp;

  // Dopamin effect
  const lvlupDiv = document.getElementById('lvlup');
  lvlupDiv.style.transform = 'translate(-50%,-50%) scale(1.5)';
  lvlupDiv.style.transition = 'transform 0.5s ease-out';
  setTimeout(()=>{ lvlupDiv.style.transform='translate(-50%,-50%) scale(0)'; },800);

  playLevelUpSound(lvl<=2?0:1);

  // Zoom for dopamine on bigger lvls
  if(lvl>2){
    camera.position.y += 5;
    setTimeout(()=>{ camera.position.y -=5; },500);
  }

  // Weapon choice popup
  if(lvl===3) showWeaponChoice();
}

/* ---------- WEAPON CHOICE ---------- */
function showWeaponChoice() {
  alert("Choose your weapon now!");
}

/* ---------- LEVEL UP SOUND ---------- */
function playLevelUpSound(type) {
  const audio = new Audio();
  if(type===0) audio.src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg";
  else audio.src="https://actions.google.com/sounds/v1/cartoon/metal_twang.ogg";
  audio.play();
}

/* ---------- ANIMATE ---------- */
function animate() {
  requestAnimationFrame(animate);

  if(player.dashCooldown>0) player.dashCooldown--;

  // Example enemy movement placeholder
  enemies.forEach(e => { e.position.x += (Math.random()-0.5)*0.1; e.position.z += (Math.random()-0.5)*0.1; });

  // Meteors / exp / particles
  meteors = meteors.filter(m => m.update ? m.update()!==false : true);
  expGems.forEach(g => g.update ? g.update(player.position) : null);
  particles = particles.filter(p => p.update ? p.update()!==false : true);

  renderer.render(scene,camera);
}

/* ---------- INIT ---------- */
try{ init(); } catch(e){ console.error(e); alert("Game Error: "+e.message); }
</script>
</body>
</html>